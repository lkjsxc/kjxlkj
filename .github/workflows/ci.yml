name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  docs-integrity:
    name: Docs Integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify canonical docs tree
        run: |
          set -e
          for d in guides overview policy reference spec todo; do
            test -d "docs/$d" || { echo "FAIL: docs/$d missing"; exit 1; }
          done
      - name: Verify required reference ledgers
        run: |
          set -e
          for f in CI.md CONFORMANCE.md DRIFT_MATRIX.md EVIDENCE_INDEX.md LIMITATIONS.md RELEASE.md IMPROVEMENT_BACKLOG.md; do
            test -f "docs/reference/$f" || { echo "FAIL: docs/reference/$f missing"; exit 1; }
          done
      - name: Verify TODO policy blocks
        run: |
          set -e
          MISSING=$(rg -L "^## Relevant Documents" docs/todo -g '*.md' || true)
          if [ -n "$MISSING" ]; then
            echo "FAIL: missing '## Relevant Documents' in:"
            echo "$MISSING"
            exit 1
          fi
          WAVE_MISSING=$(rg -L "^## Mandatory Build and Test Gate" docs/todo/waves -g 'wave-*.md' || true)
          if [ -n "$WAVE_MISSING" ]; then
            echo "FAIL: missing build/test gate section in:"
            echo "$WAVE_MISSING"
            exit 1
          fi

  runtime-build-and-test:
    name: Runtime Build and Test
    needs: docs-integrity
    if: ${{ hashFiles('Cargo.toml') != '' && hashFiles('src/**') != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cargo build
        run: cargo build --workspace
      - name: Cargo test
        run: cargo test --workspace -- --nocapture
