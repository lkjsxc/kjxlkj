# CI workflow per /docs/reference/CI.md
# Verification profiles: Docs-integrity → Workspace-bootstrap → Core-runtime → Release
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # Profile: Docs-integrity
  docs-integrity:
    name: Docs Integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check docs structure
        run: |
          test -f docs/README.md
          test -f docs/policy/INSTRUCT.md
          test -f docs/spec/README.md
          test -f docs/todo/README.md
          test -f docs/reference/CONFORMANCE.md
          test -f docs/reference/LIMITATIONS.md
          test -f docs/reference/DRIFT_MATRIX.md
          echo "Docs structure verified"

  # Profile: Workspace-bootstrap
  workspace-bootstrap:
    name: Workspace Bootstrap
    runs-on: ubuntu-latest
    needs: docs-integrity
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Cargo check
        run: cargo check --workspace
      - name: Frontend type check
        run: |
          cd src/frontend/app
          npm ci
          npx tsc --noEmit
      - name: Frontend build
        run: |
          cd src/frontend/app
          npx vite build
      - name: No handwritten JS check
        run: |
          if find src -name '*.js' -not -path '*/dist/*' -not -path '*/node_modules/*' | grep -q .; then
            echo "ERROR: found handwritten .js files"
            exit 1
          fi
          echo "No handwritten JS found"

  # Profile: Core-runtime
  core-runtime:
    name: Core Runtime
    runs-on: ubuntu-latest
    needs: workspace-bootstrap
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cargo test
        run: cargo test --workspace -- --nocapture
      - name: Docker build
        run: |
          if command -v docker &> /dev/null; then
            docker compose build
          else
            echo "Docker not available, skipping"
          fi

  # Profile: Release (type gates)
  release-gate:
    name: Release Gate
    runs-on: ubuntu-latest
    needs: core-runtime
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Rust compile gate
        run: cargo check --workspace
      - name: TypeScript type gate
        run: |
          cd src/frontend/app
          npm ci
          npx tsc --noEmit
      - name: Summary
        run: echo "Release gate — all type gates passed"
